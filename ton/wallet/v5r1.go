package wallet

import (
	"context"
	"errors"
	"fmt"
	"time"

	"github.com/xssnick/tonutils-go/tlb"
	"github.com/xssnick/tonutils-go/ton"

	"github.com/xssnick/tonutils-go/tvm/cell"
)

// https://github.com/toncenter/tonweb/blob/master/src/contract/wallet/WalletSources.md#revision-2-3
const _V5R1CodeHex = "B5EE9C72410214010002B6000114FF00F4A413F4BCF2C80B0102012005020102F203011220D728239B4B3B74300401E6208308D722018308D723208020D721D34FD31FD31FED44D0D22020D34FD70BFF08F9014098F910F2A35122BAF2A15035BAF2A2F823BBF264F800A4C8CA2001CF16C9ED54F80F20C7108E23D74C20D020C700DC8E15D72820761E436C20D71D06C712F265D74CD020C700E630ED558E82DB3CE2110201480F060201200807001BBE5F0F6A2684080B8EB90FA021840201200C090201200B0A0019B45D1DA89A10043AE43AE169F00015B592FDA89A1AE14416C1700202760E0D0014A880ED44D0D70A20C2FF0018AB9CED44D08071D721D70BFF02D8D020C702DC01D0D60301C713DC01D72C232BC3A3748EC701FA4030FA4401A4B2ED44D0810171D721F4058307F40EDD21C7108E2430D74C20D020C700DC8E15D72820761E436C20D71D06C712F265D74CD020C700E630ED558E8330DB3CE28E8B3120D72C239B4B73A431DDE2111001F020D7498102B1B9DC208308D722018308D723208020D721D34FD31FD31FED44D0D22020D34FD70BFF08F9014098F910DD5122BAF2A15035BAF2A2F823BBF264A4C8CA2001CF16C9ED54F80F20C7108E23D74C20D020C700DC8E15D72820761E436C20D71D06C712F265D74CD020C700E630ED558E82DB3CE21102CA93D200018EDCD72C20E206DCFC2091709901D72C22F577A52412E25210B18E3D30D72C21065DCAD48E2FD200ED44D0D2205204983020C100F2ABA3A48E1121C2FFF2AB810150D721D70B00F2AAA4A3E2C8CA2058CF16C9ED5492F229E2E30DD74CD0E8D74C1312004220D020C700DC8E15D72820761E436C20D71D06C712F265D74CD020C700E630ED55008C01FA4001FA4421A4B2ED44D0810171D71821D70A2001F405069D3002C8CA0740148307F453F2A78E1133048307F45BF2A8206E02C10012B0F26CE2C85003CF1612F400C9ED549B4062A2"

type SpecV5R1 struct {
	SpecRegular
	SpecSeqno
}

func (s *SpecV5R1) BuildMessage(ctx context.Context, _ bool, _ *ton.BlockIDExt, messages []*Message) (_ *cell.Cell, err error) {
	// TODO: remove block, now it is here for backwards compatibility

	if len(messages) > 4 {
		return nil, errors.New("for this type of wallet max 4 messages can be sent in the same time")
	}

	seq, err := s.seqnoFetcher(ctx, s.wallet.subwallet)
	if err != nil {
		return nil, fmt.Errorf("failed to fetch seqno: %w", err)
	}

	payload := cell.BeginCell().MustStoreUInt(uint64(s.wallet.subwallet), 32).
		MustStoreUInt(uint64(timeNow().Add(time.Duration(s.messagesTTL)*time.Second).UTC().Unix()), 32).
		MustStoreUInt(uint64(seq), 32).
		MustStoreInt(0, 8) // op

	for i, message := range messages {
		intMsg, err := tlb.ToCell(message.InternalMessage)
		if err != nil {
			return nil, fmt.Errorf("failed to convert internal message %d to cell: %w", i, err)
		}

		payload.MustStoreUInt(uint64(message.Mode), 8).MustStoreRef(intMsg)
	}

	sign := payload.EndCell().Sign(s.wallet.key)
	msg := cell.BeginCell().MustStoreSlice(sign, 512).MustStoreBuilder(payload).EndCell()

	return msg, nil
}

// TODO: implement plugins
